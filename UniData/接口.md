# UniData API 参考

> UniData 分布式数据同步服务 API 接口文档

## 修订历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-01-28 | 初始版本 |

---

## 1. 概述

UniData API 是基于 RESTful 风格设计的接口服务，用于管理分布式数据同步场景中的测试用例和索引数据。所有接口均采用 JWT 进行身份认证，支持 HS256 签名算法。

### 1.1 API 基础信息

| 项目 | 说明 |
|------|------|
| 服务地址 | `{host}/api/v1` |
| 协议 | HTTPS/HTTP |
| 数据格式 | JSON |
| 字符编码 | UTF-8 |

### 1.2 版本说明

当前 API 版本为 **v1**，所有接口统一以 `/api/v1` 为前缀。

```
https://{host}/api/v1/{resource}
```

---

## 2. 公共参数

### 2.1 公共请求参数

以下参数在所有接口中均为必填：

| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| Authorization | string | Header | 是 | JWT 认证令牌，格式：`Bearer {token}` |
| X-App-Name | string | Header | 否 | 应用名称，用于与 JWT 内容交叉校验 |

### 2.2 JWT Token 说明

JWT Token 采用 HS256 签名算法，Payload 中应包含以下字段：

| 字段 | 类型 | 必填 | 描述 |
|------|------|------|------|
| app_name / sub | string | 是 | 应用名称 |
| scopes / scope | string[] | 否 | 权限范围列表 |
| exp | number | 否 | 过期时间戳（秒） |

**Token 示例：**

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBfbmFtZSI6ImFwcC1uYW1lIiwic2NvcGVzIjoicmVhZCB3cml0ZSIsImV4cCI6MTczNjM2NjY2MH0.signature_here
```

### 2.3 公共响应参数

| 参数名 | 类型 | 描述 |
|--------|------|------|
| status | string | 请求状态：`success` 或 `error` |
| id | string | 操作对象ID |
| code | number | 错误码（失败时返回） |
| message | string | 错误信息（失败时返回） |

---

## 3. 测试用例管理

测试用例接口用于管理分布式数据同步中的测试用例数据，支持创建、更新、查询和软删除操作。

### 3.1 创建测试用例

**请求地址：** `POST /testcases`

**请求参数：**

| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| index_uid | string | Query | 是 | 索引唯一标识 |
| - | object | Body | 是 | JSON 格式的测试用例数据，必须包含 `id` 字段 |

**请求示例：**

```
POST /api/v1/testcases?index_uid=test_index
Authorization: Bearer {token}

{
    "id": "tc_001",
    "title": "登录功能测试",
    "description": "测试用户登录流程",
    "priority": "high"
}
```

**响应参数：**

| 参数名 | 类型 | 描述 |
|--------|------|------|
| status | string | 请求状态 |
| id | string | 创建的测试用例ID |

**响应示例：**

```json
{
    "status": "success",
    "id": "tc_001"
}
```

**错误码：**

| HTTP状态码 | 错误信息 | 描述 |
|------------|----------|------|
| 400 | 缺少 'index_uid' 参数 | 未提供索引标识 |
| 400 | 无效的 JSON 格式 | 请求体非合法 JSON |
| 401 | 缺少 Authorization 头 | 未提供认证令牌 |
| 401 | 令牌已过期 | JWT 已过期 |

---

### 3.2 更新测试用例

**请求地址：** `PUT /testcases/{id}`

**路径参数：**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | string | 是 | 测试用例ID |

**请求参数：**

| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| index_uid | string | Query | 是 | 索引唯一标识 |
| - | object | Body | 是 | JSON 格式的更新数据 |

**请求示例：**

```
PUT /api/v1/testcases/tc_001?index_uid=test_index
Authorization: Bearer {token}

{
    "title": "登录功能测试（更新）",
    "priority": "medium"
}
```

**响应参数：**

| 参数名 | 类型 | 描述 |
|--------|------|------|
| status | string | 请求状态 |
| id | string | 更新的测试用例ID |

**响应示例：**

```json
{
    "status": "success",
    "id": "tc_001"
}
```

---

### 3.3 删除测试用例

**请求地址：** `DELETE /testcases/{id}`

**路径参数：**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | string | 是 | 测试用例ID |

**请求参数：**

| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| index_uid | string | Query | 是 | 索引唯一标识 |

**请求示例：**

```
DELETE /api/v1/testcases/tc_001?index_uid=test_index
Authorization: Bearer {token}
```

**响应参数：**

| 参数名 | 类型 | 描述 |
|--------|------|------|
| status | string | 请求状态 |
| id | string | 删除的测试用例ID |

**响应示例：**

```json
{
    "status": "success",
    "id": "tc_001"
}
```

**说明：** 此接口执行软删除操作，实际是将 `is_delete` 字段设置为 `true`。

---

### 3.4 获取 Meilisearch 地址

**请求地址：** `GET /testcases/meilisearch/endpoint`

**请求参数：**

| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| app_name | string | Query | 是 | 应用名称 |

**请求示例：**

```
GET /api/v1/testcases/meilisearch/endpoint?app_name=my_app
Authorization: Bearer {token}
```

**响应参数：**

| 参数名 | 类型 | 描述 |
|--------|------|------|
| app_name | string | 应用名称 |
| meilisearch_url | string | Meilisearch 服务地址 |
| api_key | string | 访问 Meilisearch 的 API 密钥 |

**响应示例：**

```json
{
    "app_name": "my_app",
    "meilisearch_url": "http://meilisearch.example.com:7700",
    "api_key": "your_api_key_here"
}
```

**错误码：**

| HTTP状态码 | 错误信息 | 描述 |
|------------|----------|------|
| 403 | 无权管理该应用的索引 | 无权访问该应用的端点 |
| 501 | Meilisearch 端点尚未配置 | 服务未配置 Meilisearch |

---

## 4. 错误码参考

### 4.1 认证错误码

| HTTP状态码 | 错误信息 | 解决方案 |
|------------|----------|----------|
| 401 | 缺少 Authorization 头 | 检查请求头是否包含 `Authorization: Bearer {token}` |
| 401 | 无效的令牌格式 | 检查 JWT Token 格式是否正确 |
| 401 | 令牌签名无效 | 检查 JWT Secret 是否正确 |
| 401 | 令牌已过期 | 重新获取有效的 JWT Token |
| 401 | 令牌中缺少 app_name | JWT Payload 中需包含 app_name 或 sub 字段 |
| 403 | 令牌与头部应用名称不匹配 | 检查 X-App-Name 是否与 JWT 中一致 |

### 4.2 请求错误码

| HTTP状态码 | 错误信息 | 解决方案 |
|------------|----------|----------|
| 400 | 缺少 'index_uid' 参数 | 请求中需包含 index_uid 查询参数 |
| 400 | 无效的 JSON 格式 | 检查请求体是否为合法的 JSON 格式 |
| 400 | 缺少 'id' 参数 | 更新/删除时需在路径中指定 id |

### 4.3 服务错误码

| HTTP状态码 | 错误信息 | 解决方案 |
|------------|----------|----------|
| 501 | Meilisearch 端点尚未配置 | 联系管理员配置 Meilisearch 服务 |

---

## 5. SDK 示例

### 5.1 Python SDK 示例

```python
import requests
import jwt
import time

class UniDataClient:
    """UniData API Python 客户端"""

    def __init__(self, base_url: str, app_name: str, jwt_secret: str):
        self.base_url = base_url
        self.app_name = app_name
        self.jwt_secret = jwt_secret

    def _get_token(self, ttl_seconds: int = 3600) -> str:
        """生成 JWT Token

        Args:
            ttl_seconds: 令牌有效期（秒）
                - 3600      = 1 小时（默认）
                - 86400     = 1 天
                - 604800    = 1 周
                - 2592000   = 30 天
                - 31536000  = 1 年
                - 315360000 = 10 年（长期有效）
        """
        payload = {
            "app_name": self.app_name,
            "scopes": ["read", "write"],
            "exp": int(time.time()) + ttl_seconds
        }
        return jwt.encode(payload, self.jwt_secret, algorithm="HS256")

    def _request(self, method: str, path: str, **kwargs) -> dict:
        """发送 API 请求"""
        url = f"{self.base_url}/api/v1{path}"
        headers = {
            "Authorization": f"Bearer {self._get_token()}",
            "X-App-Name": self.app_name
        }
        headers.update(kwargs.pop("headers", {}))
        response = requests.request(method, url, headers=headers, **kwargs)
        return response.json()

    def create_test_case(self, index_uid: str, data: dict) -> dict:
        """创建测试用例"""
        return self._request(
            "POST",
            f"/testcases?index_uid={index_uid}",
            json=data
        )

    def update_test_case(self, id: str, index_uid: str, data: dict) -> dict:
        """更新测试用例"""
        return self._request(
            "PUT",
            f"/testcases/{id}?index_uid={index_uid}",
            json=data
        )

    def delete_test_case(self, id: str, index_uid: str) -> dict:
        """删除测试用例"""
        return self._request(
            "DELETE",
            f"/testcases/{id}?index_uid={index_uid}"
        )

    def get_meilisearch_endpoint(self) -> dict:
        """获取 Meilisearch 地址"""
        return self._request(
            "GET",
            f"/testcases/meilisearch/endpoint?app_name={self.app_name}"
        )


# 使用示例
client = UniDataClient(
    base_url="https://api.example.com",
    app_name="my_app",
    jwt_secret="your_jwt_secret"
)

# 创建测试用例
result = client.create_test_case("test_index", {
    "id": "tc_001",
    "title": "测试用例",
    "priority": "high"
})
print(result)

# 获取 Meilisearch 地址
endpoint = client.get_meilisearch_endpoint()
print(endpoint)
```

### 5.2 cURL 示例

```bash
# 设置变量
BASE_URL="https://api.example.com"
APP_NAME="my_app"
JWT_SECRET="your_jwt_secret"

# 生成 Token（默认1小时有效）
TOKEN=$(python3 -c "
import jwt
import time
payload = {
    'app_name': '$APP_NAME',
    'exp': int(time.time()) + 3600  # 1小时后过期
}
print(jwt.encode(payload, '$JWT_SECRET', algorithm='HS256'))
")

# 生成长期 Token（10年有效）
TOKEN_LONGTERM=$(python3 -c "
import jwt
import time
payload = {
    'app_name': '$APP_NAME',
    'exp': int(time.time()) + 315360000  # 10年后过期
}
print(jwt.encode(payload, '$JWT_SECRET', algorithm='HS256'))
")

# 创建测试用例
curl -X POST "$BASE_URL/api/v1/testcases?index_uid=test_index" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-App-Name: $APP_NAME" \
  -H "Content-Type: application/json" \
  -d '{"id":"tc_001","title":"测试用例","priority":"high"}'

# 使用长期 Token 创建测试用例
curl -X POST "$BASE_URL/api/v1/testcases?index_uid=test_index" \
  -H "Authorization: Bearer $TOKEN_LONGTERM" \
  -H "X-App-Name: $APP_NAME" \
  -H "Content-Type: application/json" \
  -d '{"id":"tc_002","title":"长期有效测试用例","priority":"high"}'

# 获取 Meilisearch 地址
curl -X GET "$BASE_URL/api/v1/testcases/meilisearch/endpoint?app_name=$APP_NAME" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-App-Name: $APP_NAME"

# 删除测试用例
curl -X DELETE "$BASE_URL/api/v1/testcases/tc_001?index_uid=test_index" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-App-Name: $APP_NAME"
```

### 5.3 使用脚本生成长期 Token

可以直接使用项目提供的脚本生成长期有效的 JWT：

```bash
# 生成 10 年有效的 Token（推荐用于生产环境长期运行的服务）
python scripts/generate_jwt.py --app-name myapp --ttl 315360000

# 生成 1 年有效的 Token
python scripts/generate_jwt.py --app-name myapp --ttl 31536000

# 生成 30 天有效的 Token
python scripts/generate_jwt.py --app-name myapp --ttl 2592000
```

**TTL 参考值：**

| TTL 值 | 有效期 |
|--------|--------|
| 3600 | 1 小时 |
| 86400 | 1 天 |
| 604800 | 1 周 |
| 2592000 | 30 天 |
| 31536000 | 1 年 |
| 315360000 | 10 年（长期） |

---

## 6. 附录

### 6.1 数据存储说明

- 测试用例数据存储在 PostgreSQL 数据库中，使用 JSONB 格式存储自定义字段
- 索引信息同步存储在 Meilisearch 搜索引擎中
- 支持软删除机制，删除操作仅标记 `is_delete` 字段

### 6.2 认证流程

```
┌─────────┐     1.发送请求      ┌─────────┐     2.解析 JWT     ┌─────────────┐
│  Client │ ──────────────────▶ │  Server │ ─────────────────▶ │ JWT Validator│
└─────────┘                     └─────────┘                   └─────────────┘
                                    │                                  │
                                    │ 3.返回结果                        │ 4.验证签名
                                    │◀─────────────────────────────────│
                                    │                                  │
                                    ▼                                  ▼
                              ┌─────────┐                      ┌─────────────┐
                              │ 业务逻辑 │                      │ 提取 app_name│
                              └─────────┘                      └─────────────┘
```

---

## 7. 联系我们

如有任何问题，请联系技术支持团队。

---