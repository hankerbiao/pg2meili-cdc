# HTTP 搜索服务接口说明

## 服务基础信息

- 启动入口：`main.go`
- 监听地址：从环境变量 `HTTP_ADDR` 读取，默认值 `:8091`
- 路由注册：
  - `GET/POST /search` 由 `handler.NewSearchHandler` 处理

## 认证方式

- Header 中必须携带 `Authorization` 头
- 格式：`Authorization: Bearer <JWT_TOKEN>`
- JWT 校验：
  - 使用配置项 `JWT_SECRET` 校验 HS256 签名
  - 校验 `exp` 过期时间
- 应用身份：
  - 从 JWT 载荷中的 `app_name` 或 `sub` 字段解析出 `AppName`
  - 解析结果用于限制可访问的索引

## /search 接口

- 方法：`POST`
- 路径：`/search`
- 认证：必须，`Authorization: Bearer <token>`
- Content-Type：`application/json`

### 请求体结构

对应结构体 `model.SearchProxyRequest`：

```json
{
  "index_uid": "可选，索引名",
  "q": "搜索关键字，必填",
  "offset": 0,
  "limit": 20,
  "filter": {},
  "sort": [
    "field:asc",
    "field:desc"
  ]
}
```

- `index_uid`：
  - 可选
  - 若为空，由服务根据 JWT 中的 `app_name` 以及配置项 `MEILI_INDEX` 计算期望索引：
    - 无 `app_name` 时：索引为 `MEILI_INDEX`
    - 有 `app_name` 时：索引为 `app_name + "_" + MEILI_INDEX`
  - 若请求中指定了 `index_uid`，只能等于上述期望索引，否则返回 403
- `q`：
  - 必填
  - 搜索关键词，若缺失返回 400
- `offset`：
  - 可选
  - 分页偏移量，对应 Meilisearch `offset`
- `limit`：
  - 可选
  - 返回条数限制，对应 Meilisearch `limit`
- `filter`：
  - 可选
  - 过滤条件，透传给 Meilisearch `filter`
- `sort`：
  - 可选
  - 排序字段数组，透传给 Meilisearch `sort`

### 索引访问控制

- 服务根据 JWT 中的 `AppName` 计算期望索引 `expectedIndex`：
  - `expectedIndex = MEILI_INDEX`（无 AppName）
  - `expectedIndex = AppName + "_" + MEILI_INDEX`（有 AppName）
- 若请求体中的 `index_uid` 为空：
  - 使用 `expectedIndex` 作为最终索引名
- 若请求体中的 `index_uid` 非空：
  - 必须与 `expectedIndex` 完全一致，否则返回 403

### 返回体

- 成功：
  - 状态码：`200 OK`
  - Body：为 Meilisearch 的原始搜索响应 JSON，字段与 Meilisearch 官方文档一致
- 失败：
  - `401 Unauthorized`：
    - 缺少 `Authorization` 头
    - Token 格式错误
    - Token 验证失败或过期
  - `400 Bad Request`：
    - 请求体非合法 JSON
    - 缺少 `q` 字段
  - `403 Forbidden`：
    - 请求的 `index_uid` 与当前身份允许的索引不匹配
  - `500 Internal Server Error`：
    - 调用 Meilisearch 搜索失败

